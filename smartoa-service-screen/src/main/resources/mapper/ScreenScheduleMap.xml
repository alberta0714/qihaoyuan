<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.smartoa.service.mapper.ScreenScheduleMapper">
	<!-- 工程师 当前 飞线及状态 -->
	<select id="scEngineerTaskList"
		resultType="com.smartoa.service.model.screen.other.ScreenEngineerTask">
		SELECT
			opr.id, -- 
			(select group_concat(`tb_device`.`device_model_dict_code`) from `tb_work_order_to_deceive` left join `tb_device` on `tb_device`.`id`=tb_work_order_to_deceive.`deceive_id` where `tb_work_order_to_deceive`.`work_order_id`=wo.id ) as device_models,
			opr.arrival_time,
			opr.`if_finished`, -- 是否完工：0-未完工、1-已完工、2-取消、3-已派工       
  			opr.`task_nature`,-- ：0-送货、1-安装、2-保养、3-维修、4-更换耗材配件、5-全包安装  
  			opr.`recommended_first_treatment`,-- 0-电话支持、1-直接上门  
			opr.engineer_id,
			opr.work_order_id,
			opr.`dispatcher_time`, -- 派工时间
			opr.`finished_time`, -- 完工时间
			opr.will_go_time,
			engineer.real_name,
			engineer.user_name,
			engineer.`level` engineer_level,
			CASE 
				WHEN engineer.level = '0' THEN '初级' 
				WHEN engineer.level = '1' THEN '中级' 
				WHEN engineer.level = '2' THEN '高级' 
				ELSE engineer.level
			END AS level_name,
			engineer.`lng` AS en_lng,
			engineer.`lat` AS en_lat,
			wo.`cust_no`,
			wo.servicer_id,
			wo.status, 
			cust.`id` AS cust_id,
			cust.`lng` AS cust_lng,
			cust.cust_name,
			cust.`lat` AS cust_lat,
			cust.`delivery_address_province`, --
			province.`provinces`,
			cust.`delivery_address_city`,--
			city.`city`,
			cust.`delivery_address_county`,--
			country.`area_county`,
			opr.plan_time,
			opr.plan_time_end,
			opr.plan_time_out_long,
			opr.plan_time_out_long_end
		FROM
			`tb_work_order_opr` opr
			LEFT JOIN tb_engineer engineer ON engineer.`id` = opr.`engineer_id`
			LEFT JOIN tb_work_order wo ON wo.`id` = opr.`work_order_id`
			LEFT JOIN tb_cust cust ON cust.`id` = wo.`cust_no`
			LEFT JOIN `td_sys_provinces` province ON province.`provinces_code`=cust.`delivery_address_province`
			LEFT JOIN `td_sys_city` city ON city.`city_code`=cust.`delivery_address_city`
			LEFT JOIN `td_sys_area_county` country ON country.`area_code`= cust.`delivery_address_county`
		WHERE 1 = 1
		<if test="willGoTimeStart!=null and willGoTimeStart!=''">
			AND opr.`will_go_time`&gt;='${willGoTimeStart}'
		</if>
		<if test="willGoTimeEnd!=null and willGoTimeEnd!=''">
			AND opr.`will_go_time`&lt;='${willGoTimeEnd}'
		</if>
	</select>
	
	<select id="scWorkOrderList" resultType="map">
	SELECT 
	  wo.`id`,
	  wo.`cust_no`,
	  cust.`cust_name`,
	  wo.`servicer_id`,
	  wo.`time_out_long` 
	FROM
	  tb_work_order wo 
	  LEFT JOIN tb_cust cust 
	    ON cust.id = wo.`cust_no` 
	where 1=1
	<if test="ids!=null and ids!=''">
		and wo.`id` in (${ids})
	</if>
	</select>
	
	<select id="scWorkTime" resultType="map">
		SELECT def.`worktime_start`,def.`worktime_end_pm` FROM `tb_service_responsive_time_def` def WHERE def.`enable`=1 LIMIT 1
	</select>
</mapper>
